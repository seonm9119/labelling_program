{% extends "base.html" %}

{% block title %}Key-Value 맵핑 - Labelling Programs{% endblock %}

{% block header_subtitle %}Key-Value 맵핑 - 이미지 영역 어노테이션 도구{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/keyvalue.css') }}">
{% endblock %}

{% block content %}
<section class="keyvalue-section">
    <div class="keyvalue-header">
        <h2>🔗 Key-Value 맵핑</h2>
        <p class="keyvalue-desc">이미지에서 드래그로 영역을 선택하여 Key-Value 쌍을 라벨링합니다</p>
    </div>

    <div class="keyvalue-content">
        <!-- 이미지 업로드 -->
        <div class="kv-upload-card" id="kvUploadCard">
            <div class="card-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    이미지 업로드
                </h3>
            </div>
            <div class="kv-upload-area" id="kvUploadArea">
                <input type="file" id="kvImageInput" accept="image/*" hidden>
                <div class="kv-upload-content">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p>클릭하거나 이미지를 드래그하세요</p>
                </div>
            </div>
        </div>

        <!-- 이미지 뷰어 (이미지 로드 후 표시) -->
        <div class="kv-viewer-container" id="kvViewerContainer" hidden>
            <!-- 상단 컨트롤 -->
            <div class="kv-viewer-controls">
                <div class="kv-nav-info">
                    <span class="kv-filename" id="kvFilename">filename.jpg</span>
                    <div class="kv-zoom-controls">
                        <button class="btn-zoom" id="kvZoomOut" title="축소">−</button>
                        <span class="kv-zoom-level" id="kvZoomLevel">100%</span>
                        <button class="btn-zoom" id="kvZoomIn" title="확대">+</button>
                        <button class="btn-zoom-reset" id="kvZoomReset" title="원래 크기">↺</button>
                    </div>
                </div>
                <div class="kv-mode-indicator">
                    <span class="kv-current-mode" id="kvModeIndicator">
                        <span class="mode-label">현재:</span>
                        <span class="mode-value" id="kvModeValue">Key 1</span>
                    </span>
                    <span class="kv-hint">ESC: 새 Key | E: ETC | 휠: 확대/축소</span>
                </div>
            </div>

            <!-- 이미지 캔버스 영역 -->
            <div class="kv-canvas-wrapper" id="kvCanvasWrapper">
                <div class="kv-canvas-inner">
                    <div class="kv-canvas-container" id="kvCanvasContainer">
                        <img id="kvImage" alt="라벨링 이미지" draggable="false">
                        <canvas id="kvCanvas"></canvas>
                        <div class="kv-selection-box" id="kvSelectionBox" hidden></div>
                    </div>
                </div>
            </div>

            <!-- 현재 이미지 라벨 목록 + 텍스트 편집 -->
            <div class="kv-side-panel">
                <!-- 텍스트 편집 패널 -->
                <div class="kv-edit-panel" id="kvEditPanel" hidden>
                    <div class="kv-edit-header">
                        <h4>✏️ 텍스트 편집</h4>
                        <span class="kv-edit-target" id="kvEditTarget">-</span>
                    </div>
                    <div class="kv-edit-body">
                        <textarea class="kv-edit-textarea" id="kvEditTextarea" placeholder="텍스트를 입력하세요..."></textarea>
                    </div>
                    <div class="kv-edit-footer">
                        <button class="btn btn-save-text" id="kvSaveTextBtn">💾 저장</button>
                    </div>
                </div>
                
                <!-- 라벨 목록 -->
                <div class="kv-labels-panel">
                    <div class="kv-labels-header">
                        <h4>📋 라벨 목록</h4>
                        <button class="btn btn-clear-labels" id="kvClearLabelsBtn" title="현재 이미지 라벨 초기화">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            초기화
                        </button>
                    </div>
                    <div class="kv-labels-list" id="kvLabelsList">
                        <p class="kv-no-labels">드래그하여 영역을 선택하세요</p>
                    </div>
                </div>
            </div>

            <!-- 저장/불러오기 버튼 -->
            <div class="kv-save-actions">
                <button class="btn btn-load-json" id="kvLoadBtn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    📂 JSON 불러오기
                </button>
                <input type="file" id="kvJsonInput" accept=".json" hidden>
                <button class="btn btn-save-json" id="kvSaveBtn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    💾 JSON 저장
                </button>
                <span class="kv-save-info" id="kvSaveInfo"></span>
            </div>
        </div>

        <!-- 사용법 안내 -->
        <div class="kv-help-card" id="kvHelpCard">
            <h4>📖 사용법</h4>
            <ul>
                <li><strong>드래그</strong>: 영역 선택 (첫 드래그 = Key, 이후 = Value)</li>
                <li><strong>클릭</strong>: 박스 선택 → 드래그로 이동</li>
                <li><strong>더블클릭</strong>: 오른쪽 패널에서 텍스트 편집</li>
                <li><strong>Delete</strong>: 선택된 박스 삭제</li>
                <li><strong>ESC</strong>: 새로운 Key 시작 (ETC 모드 해제)</li>
                <li><strong>E</strong>: ETC 모드 토글 (기타 라벨용)</li>
                <li><strong>마우스 휠</strong>: 이미지 확대/축소 (50%~500%)</li>
                <li><strong>저장</strong>: JSON 파일로 내보내기</li>
            </ul>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/keyvalue.js') }}"></script>
{% endblock %}
