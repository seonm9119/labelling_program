{% extends "base.html" %}

{% block title %}OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ{% endblock %}

{% block header_title %}ğŸ“ OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ{% endblock %}

{% block header_subtitle %}AI ê¸°ë°˜ ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì¸ì‹ ë° ì¶”ì¶œ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/clip.css') }}">
<style>
/* OCR ì „ìš© ìŠ¤íƒ€ì¼ */
.ocr-result-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
}

.ocr-result-card h4 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ocr-text-output {
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    padding: 1rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--text-secondary);
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
}

.ocr-image-preview {
    max-width: 100%;
    max-height: 400px;
    border-radius: var(--radius-md);
    margin-bottom: 1rem;
}

/* OCR Canvas ê²°ê³¼ í‘œì‹œ */
.ocr-canvas-container {
    position: relative;
    width: 100%;
    height: 600px;
    overflow: hidden;
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    margin-bottom: 1rem;
    cursor: grab;
    user-select: none;
}

.ocr-canvas-container:active {
    cursor: grabbing;
}

.ocr-canvas-wrapper {
    position: absolute;
    transform-origin: 0 0;
}

#ocrResultCanvas {
    display: block;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* ì¤Œ ì¸ë””ì¼€ì´í„° */
.ocr-zoom-indicator {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-sm);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    pointer-events: none;
    z-index: 10;
}

/* ì»¨íŠ¸ë¡¤ íŒíŠ¸ */
.ocr-controls-hint {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
    color: var(--text-muted);
}

.ocr-controls-hint span {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ocr-controls-hint kbd {
    background: var(--bg-tertiary);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
}

/* ìƒ‰ìƒ ë²”ë¡€ */
.ocr-legend {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    color: var(--text-secondary);
    flex-wrap: wrap;
}

.ocr-legend-title {
    font-weight: 600;
    color: var(--text-primary);
}

.ocr-legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.ocr-legend-color {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    flex-shrink: 0;
}

.ocr-stats {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.ocr-stat {
    background: var(--bg-elevated);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
}

.ocr-stat strong {
    color: var(--accent-primary);
}

.batch-results-list {
    max-height: 500px;
    overflow-y: auto;
}

.batch-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    margin-bottom: 0.5rem;
    border: 1px solid var(--border-color);
}

.batch-result-item .filename {
    font-weight: 500;
    color: var(--text-primary);
}

.batch-result-item .char-count {
    color: var(--text-muted);
    font-size: 0.85rem;
}

.batch-result-item.success {
    border-left: 3px solid var(--success-color, #10b981);
}

.batch-result-item.error {
    border-left: 3px solid var(--error-color, #ef4444);
}
</style>
{% endblock %}

{% block content %}
<!-- ëª¨ë“œ ì„ íƒ íƒ­ -->
<section class="mode-tabs">
    <button class="mode-tab active" data-mode="single">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M9 9H15M9 12H15M9 15H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        ë‹¨ì¼ ì´ë¯¸ì§€ OCR
    </button>
    <button class="mode-tab" data-mode="batch">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2"/>
            <path d="M13 2V9H20" stroke="currentColor" stroke-width="2"/>
        </svg>
        ëŒ€ìš©ëŸ‰ ì²˜ë¦¬
        <span class="badge-new">Batch</span>
    </button>
</section>

<!-- ë‹¨ì¼ ëª¨ë“œ ì„¹ì…˜ -->
<section class="input-section" id="singleModeSection">
    <div class="input-grid" style="display: flex; flex-direction: column; align-items: center;">
        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
        <div class="upload-card" id="imageCard" style="max-width: 500px; width: 100%;">
            <div class="upload-area" id="imageArea">
                <input type="file" id="imageInput" accept="image/*" hidden>
                <div class="upload-content">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h3>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
                    <p>OCR ì²˜ë¦¬í•  ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    <span class="upload-hint">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</span>
                </div>
                <div class="preview-container" id="imagePreview" hidden>
                    <img id="previewImg" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€">
                    <button class="remove-btn" id="removeImage">Ã—</button>
                </div>
            </div>
            <div class="file-info" id="imageInfo"></div>
        </div>

        <!-- ë‹¨ì¼ ëª¨ë“œ ì¶”ì¶œ ë²„íŠ¼ -->
        <div class="action-buttons" style="margin-top: 1.5rem;">
            <button class="btn btn-analyze" id="extractBtn" disabled>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2"/>
                    <path d="M9 15H15M9 11H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                ğŸ“ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            </button>
        </div>
    </div>
</section>

<!-- ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ ëª¨ë“œ ì„¹ì…˜ -->
<section class="input-section" id="batchModeSection" hidden>
    <!-- í´ë” ê²½ë¡œ ì…ë ¥ -->
    <div class="path-card full-width" style="margin-bottom: 1.5rem;">
        <label for="batchFolderPath">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 19C22 19.5304 21.7893 20.0391 21.4142 20.4142C21.0391 20.7893 20.5304 21 20 21H4C3.46957 21 2.96086 20.7893 2.58579 20.4142C2.21071 20.0391 2 19.5304 2 19V5C2 4.46957 2.21071 3.96086 2.58579 3.58579C2.96086 3.21071 3.46957 3 4 3H9L11 6H20C20.5304 6 21.0391 6.21071 21.4142 6.58579C21.7893 6.96086 22 7.46957 22 8V19Z" stroke="currentColor" stroke-width="2"/>
            </svg>
            ì´ë¯¸ì§€ í´ë” ê²½ë¡œ
        </label>
        <input type="text" id="batchFolderPath" placeholder="ì˜ˆ: /home/user/images">
        <p class="path-hint">
            ì˜ˆ: <code>/home/user/images</code>
        </p>
    </div>

    <!-- ì¶œë ¥ í´ë” ì„¤ì • -->
    <div class="path-card full-width" style="margin-bottom: 1.5rem;">
        <label for="outputFolderPath">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 19C22 19.5304 21.7893 20.0391 21.4142 20.4142C21.0391 20.7893 20.5304 21 20 21H4C3.46957 21 2.96086 20.7893 2.58579 20.4142C2.21071 20.0391 2 19.5304 2 19V5C2 4.46957 2.21071 3.96086 2.58579 3.58579C2.96086 3.21071 3.46957 3 4 3H9L11 6H20C20.5304 6 21.0391 6.21071 21.4142 6.58579C21.7893 6.96086 22 7.46957 22 8V19Z" stroke="currentColor" stroke-width="2"/>
                <line x1="12" y1="11" x2="12" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line x1="9" y1="14" x2="15" y2="14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            ê²°ê³¼ ì €ì¥ í´ë” ê²½ë¡œ
        </label>
        <input type="text" id="outputFolderPath" placeholder="ì˜ˆ: /home/user/ocr_results">
        <p class="path-hint">
            ì˜ˆ: <code>/home/user/ocr_results</code> (ì—†ìœ¼ë©´ ìë™ ìƒì„±)
        </p>
    </div>

    <div class="multi-ref-hint">
        <p><strong>ğŸ“‹ ì²˜ë¦¬ ë°©ì‹:</strong> í´ë” ë‚´ ëª¨ë“  ì´ë¯¸ì§€ë¥¼ OCR ì²˜ë¦¬í•˜ì—¬ ê° ì´ë¯¸ì§€ë³„ í…ìŠ¤íŠ¸ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p>
        <p style="margin-top: 0.5rem; font-size: 0.9em; color: var(--text-muted);">
            ì˜ˆ: image1.jpg â†’ image1.json (ì¶”ì¶œëœ í…ìŠ¤íŠ¸ í¬í•¨)
        </p>
    </div>

    <!-- ëŒ€ìš©ëŸ‰ ëª¨ë“œ ì¶”ì¶œ ë²„íŠ¼ -->
    <div class="action-buttons" style="margin-top: 1.5rem; justify-content: center;">
        <button class="btn btn-analyze" id="batchExtractBtn" disabled>
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2"/>
                <path d="M14 2V8H20" stroke="currentColor" stroke-width="2"/>
                <path d="M9 15H15M9 11H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            ğŸ“ ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        </button>
    </div>
</section>

<!-- ì§„í–‰ ìƒí™© -->
<section class="progress-section" id="progressSection" hidden>
    <div class="progress-card">
        <div class="progress-header">
            <div class="progress-spinner"></div>
            <span class="progress-title" id="progressTitle">OCR ì²˜ë¦¬ ì¤‘...</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-main">
                <div class="progress-fill-main" id="progressFill"></div>
            </div>
        </div>
        <div class="progress-stats">
            <span class="progress-count"><span id="progressCurrent">0</span> / <span id="progressTotal">0</span></span>
            <span class="progress-percent-main"><span id="progressPercent">0</span>%</span>
        </div>
    </div>
</section>

<!-- ë‹¨ì¼ ê²°ê³¼ ì„¹ì…˜ -->
<section class="results-section" id="singleResultSection" hidden>
    <div class="results-header">
        <h2>ğŸ“„ OCR ê²°ê³¼</h2>
        <div class="ocr-stats">
            <span class="ocr-stat">ë¬¸ì ìˆ˜: <strong id="charCount">0</strong></span>
            <span class="ocr-stat">ë‹¨ì–´ ìˆ˜: <strong id="wordCount">0</strong></span>
            <span class="ocr-stat">ì¤„ ìˆ˜: <strong id="lineCount">0</strong></span>
            <span class="ocr-stat">ë°•ìŠ¤ ìˆ˜: <strong id="boxCount">0</strong></span>
            <span class="ocr-stat">í‰ê·  ì‹ ë¢°ë„: <strong id="avgConfidence">0%</strong></span>
        </div>
    </div>
    
    <div class="ocr-result-card">
        <h4>ğŸ–¼ï¸ OCR ê²°ê³¼ ì‹œê°í™” (BBox + í…ìŠ¤íŠ¸)</h4>
        
        <!-- ì»¨íŠ¸ë¡¤ íŒíŠ¸ -->
        <div class="ocr-controls-hint">
            <span><kbd>ìŠ¤í¬ë¡¤</kbd> í™•ëŒ€/ì¶•ì†Œ</span>
            <span><kbd>ë“œë˜ê·¸</kbd> ì´ë™</span>
            <span><kbd>ë”ë¸”í´ë¦­</kbd> ë¦¬ì…‹</span>
        </div>
        
        <!-- Canvas ì»¨í…Œì´ë„ˆ -->
        <div class="ocr-canvas-container" id="ocrCanvasContainer">
            <div class="ocr-canvas-wrapper" id="ocrCanvasWrapper">
                <canvas id="ocrResultCanvas"></canvas>
            </div>
            <div class="ocr-zoom-indicator" id="zoomIndicator">100%</div>
        </div>
        
        <!-- ìƒ‰ìƒ ë²”ë¡€ -->
        <div class="ocr-legend">
            <span class="ocr-legend-title">ì‹ ë¢°ë„:</span>
            <span class="ocr-legend-item">
                <span class="ocr-legend-color" style="background: #10b981;"></span>
                90% ì´ìƒ (ë†’ìŒ)
            </span>
            <span class="ocr-legend-item">
                <span class="ocr-legend-color" style="background: #f59e0b;"></span>
                70~90% (ì¤‘ê°„)
            </span>
            <span class="ocr-legend-item">
                <span class="ocr-legend-color" style="background: #ef4444;"></span>
                70% ë¯¸ë§Œ (ë‚®ìŒ)
            </span>
        </div>
        
        <!-- ì›ë³¸ ì´ë¯¸ì§€ (ìˆ¨ê¹€ - Canvasì— ê·¸ë¦¬ê¸°ìš©) -->
        <img id="resultImage" style="display: none;" alt="ì²˜ë¦¬ëœ ì´ë¯¸ì§€">
    </div>
    
    <div class="ocr-result-card">
        <h4>ğŸ“ ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h4>
        <div class="ocr-text-output" id="extractedText">
            í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
    </div>
    
    <div class="action-buttons" style="margin-top: 1rem;">
        <button class="btn btn-secondary" id="copyTextBtn">
            ğŸ“‹ í…ìŠ¤íŠ¸ ë³µì‚¬
        </button>
        <button class="btn btn-secondary" id="downloadTextBtn">
            ğŸ’¾ TXT ë‹¤ìš´ë¡œë“œ
        </button>
        <button class="btn btn-secondary" id="downloadJsonBtn">
            ğŸ“ JSON ë‹¤ìš´ë¡œë“œ
        </button>
        <button class="btn btn-secondary" id="downloadImageBtn">
            ğŸ–¼ï¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
        </button>
    </div>
</section>

<!-- ëŒ€ìš©ëŸ‰ ê²°ê³¼ ì„¹ì…˜ -->
<section class="results-section" id="batchResultSection" hidden>
    <div class="results-header">
        <h2>ğŸ“Š ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ ê²°ê³¼</h2>
        <div class="stats-badges">
            <span class="badge badge-total">ì´ <strong id="batchTotalCount">0</strong>ê°œ</span>
            <span class="badge badge-above">ì„±ê³µ <strong id="batchSuccessCount">0</strong>ê°œ</span>
            <span class="badge badge-below">ì‹¤íŒ¨ <strong id="batchErrorCount">0</strong>ê°œ</span>
        </div>
    </div>
    
    <div class="ocr-result-card">
        <h4>ğŸ“ ì²˜ë¦¬ëœ íŒŒì¼ ëª©ë¡</h4>
        <div class="batch-results-list" id="batchResultsList">
            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/ocr.js') }}"></script>
{% endblock %}
