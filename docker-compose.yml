version: '3.8'

services:
  # ============================================
  # DEV 환경 - 로컬 개발용 (127.0.0.1만 접속 가능)
  # ============================================
  labelling-dev:
    build: .
    image: labelling_program:latest
    container_name: labelling_dev
    ports:
      - "127.0.0.1:5000:5000"  # 로컬에서만 접속 가능
    volumes:
      # 개발용 - 코드 변경 시 바로 반영되도록 마운트
      - ./app.py:/app/app.py:ro
      - ./templates:/app/templates:ro
      - ./static:/app/static:ro
      - ./models:/app/models:ro
      # 배치 처리용 데이터 폴더 (전체 마운트)
      - /data:/data:ro
      - /home/aipim:/home/aipim
      # 배치 처리 출력 폴더 (쓰기 가능)
      - /data/aihub/output:/data/aihub/output
      # uploads 폴더
      - ./uploads_dev:/app/uploads
      # CLIP 모델 캐시
      - ~/.cache/clip:/root/.cache/clip
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - DEFAULT_DATA_PATH=/
    dns:
      - 8.8.8.8
      - 8.8.4.4
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

  # ============================================
  # PROD 환경 - 외부 접속 가능 (0.0.0.0)
  # ============================================
  labelling-prod:
    build: .
    image: labelling_program:latest
    container_name: labelling_prod
    ports:
      - "0.0.0.0:5001:5000"  # 외부에서 접속 가능 (포트 5001)
    volumes:
      # 코드 마운트 (dev와 동일하게)
      - ./app.py:/app/app.py:ro
      - ./templates:/app/templates:ro
      - ./static:/app/static:ro
      - ./models:/app/models:ro
      # 배치 처리용 데이터 폴더 (전체 마운트)
      - /data:/data:ro
      - /home/aipim:/home/aipim
      # 배치 처리 출력 폴더 (쓰기 가능)
      - /data/aihub/output:/data/aihub/output
      # uploads 폴더 (별도 분리)
      - ./uploads_prod:/app/uploads
      # CLIP 모델 캐시
      - ~/.cache/clip:/root/.cache/clip
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - FLASK_ENV=production
      - DEFAULT_DATA_PATH=/
    dns:
      - 8.8.8.8
      - 8.8.4.4
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

  # ============================================
  # CPU 전용 DEV (GPU가 없는 경우)
  # ============================================
  labelling-dev-cpu:
    build: .
    image: labelling_program:latest
    container_name: labelling_dev_cpu
    ports:
      - "127.0.0.1:5000:5000"
    volumes:
      - ./app.py:/app/app.py:ro
      - ./templates:/app/templates:ro
      - ./static:/app/static:ro
      - ./models:/app/models:ro
      - /home/aipim/images:/data/images:ro
      - ./uploads_dev:/app/uploads
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
    restart: unless-stopped
    profiles:
      - cpu

  # ============================================
  # CPU 전용 PROD (GPU가 없는 경우)
  # ============================================
  labelling-prod-cpu:
    build: .
    image: labelling_program:latest
    container_name: labelling_prod_cpu
    ports:
      - "0.0.0.0:5001:5000"
    volumes:
      - /home/aipim/images:/data/images:ro
      - ./uploads_prod:/app/uploads
    environment:
      - FLASK_ENV=production
    restart: unless-stopped
    profiles:
      - cpu
